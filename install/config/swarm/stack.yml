version: "3.3"

volumes:
    swarm-portainer:
        external: true
    swarm-prometheus-alertmanager:
        external: true
    swarm-prometheus:
        external: true
    swarm-grafana:
        external: true
    swarm-grafana-log:
        external: true
    swarm-grafana-etc:
        external: true

networks:
    swarm:
        external: true

services:
    portainer:
        image: newtoncodes/swarm-portainer:1.15.5
        ports:
            - "9000:9000"
        networks:
            - swarm
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - swarm-portainer:/data
        environment:
            - ADMIN_USERNAME=${SWARM_ADMIN_USERNAME:-admin}
            - ADMIN_PASSWORD=${SWARM_ADMIN_PASSWORD:-admin}
        deploy:
            placement:
                constraints:
                    - node.role == manager

    export-cadvisor:
        image: newtoncodes/swarm-prometheus-export-cadvisor:0.28.3
        ports:
            - "8080:8080" #remove
        networks:
            - swarm
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - /:/rootfs:ro
            - /var/run:/var/run
            - /sys:/sys:ro
            - /var/lib/docker/:/var/lib/docker:ro
        deploy:
            mode: global
            resources:
                limits:
                    memory: 128M
                reservations:
                    memory: 64M

    export-dockerd:
        image: newtoncodes/swarm-prometheus-export-dockerd:1.0.0
        ports:
            - "9324:9324" #remove
        networks:
            - swarm
        environment:
            - HOST_IP=${SWARM_HOST_IP:-172.18.0.1}
        deploy:
            mode: global
            resources:
                limits:
                    memory: 128M
                reservations:
                    memory: 64M

    export-node:
        image: newtoncodes/swarm-prometheus-export-node:0.15.2
        ports:
            - "9100:9100" #remove
        networks:
            - swarm
        volumes:
            - /proc:/host/proc:ro
            - /sys:/host/sys:ro
            - /:/rootfs:ro
            - /etc/hostname:/etc/nodename
        environment:
            - NODE_ID={{.Node.ID}}
        deploy:
            mode: global
            resources:
                limits:
                    memory: 128M
                reservations:
                    memory: 64M

    alertmanager:
        image: newtoncodes/swarm-prometheus-alertmanager:0.12.0
        ports:
            - "9093:9093" #remove
        networks:
            - swarm
        volumes:
            - swarm-prometheus-alertmanager:/alertmanager
        environment:
            - SLACK_KEY=${SWARM_SLACK_KEY:-undefined}
            - SLACK_CHANNEL=${SWARM_SLACK_CHANNEL:-undefined}
            - SLACK_USERNAME=${SWARM_SLACK_USERNAME:-undefined}
        deploy:
            mode: replicated
            replicas: 1
            placement:
                constraints:
                    - node.role == manager
            resources:
                limits:
                    memory: 128M
                reservations:
                    memory: 64M

    prometheus:
        image: newtoncodes/swarm-prometheus:2.0.0
        ports:
            - "9090:9090"
        networks:
            - swarm
        volumes:
            - swarm-prometheus:/prometheus
        deploy:
            mode: replicated
            replicas: 1
            placement:
                constraints:
                    - node.role == manager
            resources:
                limits:
                    memory: 2048M
                reservations:
                    memory: 1024M

    grafana:
        image: newtoncodes/swarm-grafana:4.6.3
        ports:
            - "3000:3000"
        networks:
            - swarm
        volumes:
            - swarm-grafana:/var/lib/grafana
            - swarm-grafana-log:/var/log/grafana
            - swarm-grafana-etc:/etc/grafana
        environment:
            - ADMIN_USERNAME=${SWARM_ADMIN_USERNAME:-admin}
            - ADMIN_PASSWORD=${SWARM_ADMIN_PASSWORD:-admin}
        deploy:
            mode: replicated
            replicas: 1
            placement:
                constraints:
                    - node.role == manager
            resources:
                limits:
                    memory: 128M
                reservations:
                    memory: 64M

    unsee:
        image: newtoncodes/swarm-unsee:0.8.0
        ports:
            - "3001:8080"
        networks:
            - swarm
        deploy:
            mode: replicated
            replicas: 1
            resources:
                limits:
                    memory: 1024M
                reservations:
                    memory: 128M
