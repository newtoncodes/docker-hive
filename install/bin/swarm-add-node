#!/usr/bin/env bash

SWARM_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
SWARM_PATH="$SWARM_PATH/..";

IP=$1

rm -rf ${SWARM_PATH}/config/iptables/enabled/node-${IP}.sh
rm -rf ${SWARM_PATH}/config/iptables/available/node-${IP}.sh
touch ${SWARM_PATH}/config/iptables/available/node-${IP}.sh
cat >>${SWARM_PATH}/config/iptables/available/node-${IP}.sh <<EOF

IP_EXTERNAL=`dig +short myip.opendns.com @resolver1.opendns.com`
IP_SSH_REMOTE="${IP}"


# SSH to a specific IP
iptables -A INPUT  -p tcp -s "\$IP_SSH_REMOTE" -d "\$IP_EXTERNAL" --dport 2377 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp -s "\$IP_EXTERNAL" -d "\$IP_SSH_REMOTE" --sport 2377 -m state --state ESTABLISHED     -j ACCEPT

EOF

ln -s ${SWARM_PATH}/config/iptables/available/node-${IP}.sh ${SWARM_PATH}/config/iptables/enabled/node-${IP}.sh

IP_EXTERNAL=`dig +short myip.opendns.com @resolver1.opendns.com`
IP_SSH_REMOTE="${IP}"

iptables -A INPUT  -p tcp -s "$IP_SSH_REMOTE" -d "$IP_EXTERNAL" --dport 2377 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp -s "$IP_EXTERNAL" -d "$IP_SSH_REMOTE" --sport 2377 -m state --state ESTABLISHED     -j ACCEPT

iptables-save > /tmp/iptables.save

${SWARM_PATH}/bin/iptables

iptables-restore < /tmp/iptables.save

